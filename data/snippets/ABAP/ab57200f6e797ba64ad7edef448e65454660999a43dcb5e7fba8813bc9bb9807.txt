*&---------------------------------------------------------------------*
*& Report ZTEST_REPORT                                                 *
*&---------------------------------------------------------------------*
*& Purpose: This report generates a list of customers and their orders. *
*& Execution Date: <SY-DATUM>                                           *
*&---------------------------------------------------------------------*

REPORT ZTEST_REPORT.

TABLES: KNA1, VBAK, VBAP.

DATA: BEGIN OF CUSTOMER_DATA,
      CUST_ID TYPE KNA1-KUNNR,
      CUST_NAME TYPE KNA1-NAME1,
      CUST_CITY TYPE KNA1-CITY,
      END OF CUSTOMER_DATA.

DATA: BEGIN OF ORDER_DATA,
      ORDER_ID TYPE VBAK-VBELN,
      ORDER_DATE TYPE VBAK-ERDAT,
      ORDER_STATUS TYPE VBAK-AUART,
      END OF ORDER_DATA.

DATA: BEGIN OF ITEM_DATA,
      ORDER_ID TYPE VBAP-VBELN,
      MATERIAL TYPE VBAP-MATNR,
      QUANTITY TYPE VBAP-WMENG,
      END OF ITEM_DATA.

DATA: CUSTOMER_TABLE LIKE SORTED TABLE OF CUSTOMER_DATA WITH UNIQUE KEY CUST_ID,
      ORDER_TABLE LIKE SORTED TABLE OF ORDER_DATA WITH NON-UNIQUE SORTED KEY ORDER_DATE WITH HEADER LINE,
      ITEM_TABLE LIKE SORTED TABLE OF ITEM_DATA WITH NON-UNIQUE SORTED KEY ORDER_ID WITH HEADER LINE.

SELECT KUNNR
       NAME1
       CITY
  FROM KNA1
  INTO TABLE CUSTOMER_TABLE
  WHERE CITY = 'New York'.

SELECT VBELN
       ERDAT
       AUART
  FROM VBAK
  INTO TABLE ORDER_TABLE
  FOR ALL ENTRIES IN CUSTOMER_TABLE
  WHERE KUNNR = CUSTOMER_TABLE-CUST_ID
  AND AUART = 'ZOR'.

SELECT VBELN
       MATNR
       WMENG
  FROM VBAP
  INTO TABLE ITEM_TABLE
  FOR ALL ENTRIES IN ORDER_TABLE
  WHERE VBELN = ORDER_TABLE-ORDER_ID.

LOOP AT CUSTOMER_TABLE INTO CUSTOMER_DATA.
  WRITE: / CUSTOMER_DATA-CUST_ID, CUSTOMER_DATA-CUST_NAME, CUSTOMER_DATA-CUST_CITY.
  LOOP AT ORDER_TABLE WHERE KUNNR = CUSTOMER_DATA-CUST_ID.
    WRITE: / 'Order ID:', ORDER_TABLE-VBELN, 'Order Date:', ORDER_TABLE-ERDAT, 'Order Status:', ORDER_TABLE-AUART.
    LOOP AT ITEM_TABLE WHERE VBELN = ORDER_TABLE-VBELN.
      WRITE: / 'Material:', ITEM_TABLE-MATNR, 'Quantity:', ITEM_TABLE-WMENG.
    ENDLOOP.
  ENDLOOP.
ENDLOOP.